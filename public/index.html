<html>
  <head>
    <title>Design | Metatooth</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
  </head>
  <body>
    <div id="container"></div>
    <div id="logo"><img width="200" src="images/metatooth.png" alth="Metatooth Logo"></div>
    <script type="module">
      import * as THREE from '../build/three.module.js';

      import { OrbitControls } from './jsm/controls/OrbitControls.js';
      import { STLLoader } from './jsm/loaders/STLLoader.js';
      import { WEBGL } from './jsm/WebGL.js';

      let container;

      let camera, controls, scene, renderer;
      let ambient, key_light, fill_light, back_light, top_light;
      
      if ( WEBGL.isWebGLAvailable() ) {
	  
	  init();
	  animate();
	  
      } else {
	  
	  var warning = WEBGL.getWebGLErrorMessage();
	  document.getElementById( 'container' ).appendChild( warning );
	  
      }
      
      function init() {

	  container = document.getElementById('container');

	  // Camera
	  
	  const frustumSize = 1000;
	  const aspect = window.innerWidth / window.innerHeight;
	  
	  camera = new THREE.OrthographicCamera(frustumSize * aspect / -2, frustumSize * aspect / 2, frustumSize / 2, frustumSize / -2, 1, 1000);
	  camera.lookAt(0, 0, 0);
	  camera.zoom = 10;
	  camera.updateProjectionMatrix();

	  // Scene
	  
	  scene = new THREE.Scene();
	  
	  // Lights

	  ambient = new THREE.AmbientLight(0xffffff, 0.25);
	  scene.add(ambient);
	  
	  key_light = new THREE.DirectionalLight(new THREE.Color('hsl(30, 100%, 75%)'), 1.0);
	  key_light.position.set(-100, 0, 100);

	  fill_light = new THREE.DirectionalLight(new THREE.Color('hsl(240, 100%, 75%)'), 0.75);
	  fill_light.position.set(100, 0, 100);

	  back_light = new THREE.DirectionalLight(0xffffff, 1.0);
	  back_light.position.set(100, 0, -100).normalize();

	  top_light = new THREE.DirectionalLight(0xffffff, 1.0);
	  top_light.position.set(0, -100, 0);

	  scene.add(key_light);
	  scene.add(fill_light);
	  scene.add(back_light);
	  //scene.add(top_light);

	  // Model

	  const query_string = window.location.search;
	  const url_params = new URLSearchParams(query_string);

	  const asset = url_params.get('asset');
	  
	  var xhttp = new XMLHttpRequest();
	  
	  xhttp.open('GET', 'http://localhost:9393/assets/'+asset);
	  xhttp.setRequestHeader('Content-Type', 'application/json');
	  xhttp.setRequestHeader('Authorization', 'Metaspace-Token api_key=136:619746b7f0441005bfa7e945c05988fc');
	  
	  const loader = new STLLoader();

	  xhttp.onreadystatechange = function() {
	      if (this.readyState == 4 && this.status == 200) {
		  const asset = JSON.parse(this.response).data;
		  
		  loader.load(asset.url, function ( geometry ) {
		      const material = new THREE.MeshPhongMaterial( { color: 0x00bbee, specular: 0x111111, shininess: 200 } );
		      const mesh = new THREE.Mesh( geometry, material );
		      
		      scene.add(mesh);
		  });
		  
	      }
	  };
	  
	  xhttp.send();

	  // Renderer
	  
	  renderer = new THREE.WebGLRenderer();
	  renderer.setPixelRatio(window.devicePixelRatio);
	  renderer.setSize(window.innerWidth, window.innerHeight);
	  renderer.setClearColor(new THREE.Color('hsl(0, 0%, 10%)'));
	  
	  container.appendChild(renderer.domElement);

	  // Controls
	  
	  controls = new OrbitControls(camera, renderer.domElement);
	  controls.enablePan = false;
	  controls.enableDamping = true; // an animation loop is required when either damping or auto-rotation are enabled
	  controls.dampingFactor = 0.25;
	  controls.screenSpacePanning = false;
	  controls.minDistance = 100;
	  controls.maxDistance = 500;
	  controls.maxPolarAngle = Math.PI;

	  // Events

	  window.addEventListener('resize', onWindowResize, false);
	  window.addEventListener('keydown', onKeyboardEvent, false);
      }

      function onWindowResize() {
	  camera.aspect = window.innerWidth / window.innerHeight;
	  camera.updateProjectionMatrix();

	  renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function onKeyboardEvent(e) {
      }
      
      function animate() {
	  requestAnimationFrame(animate);
	  
	  controls.update();

	  render();
      }

      function render() {
	  renderer.render(scene, camera);
      }

    </script>
  </body>
</html>
